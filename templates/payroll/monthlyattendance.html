{% extends 'panel/index.html' %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body, h1, h3, h5, th, td, label, button {
    font-family: 'Roboto', sans-serif;
}

.card {
    border-radius: 20px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.10);
    border: none;
    overflow: hidden;
}

.card-header {
    background: linear-gradient(135deg, #0d6efd, #0a58ca);
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
}

thead {
    background-color: #212529 !important;
    color: white;
    text-align: center;
}

td {
    vertical-align: middle;
    text-align: center;
}

.status {
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
}

/* STATUS COLORS */
.p { background-color: #198754; color: white; }
.a { background-color: #dc3545; color: white; }
.half { background-color: #fd7e14; color: white; }
.mis { background-color: #6f42c1; color: white; }
.late { background-color: #ffc107; color: black; }
.cl { background-color: #0dcaf0; color: black; }
.ml { background-color: #20c997; color: white; }
.perm { background-color: #adb5bd; color: black; }
.woff { background-color: #343a40; color: white; }
.holiday { background-color: #6610f2; color: white; }
.lop { background-color: #000; color: white; }

.btn-primary {
    background: linear-gradient(135deg, #0d6efd, #0a58ca);
    border: none;
    border-radius: 10px;
}
</style>

<div class="container mt-4">
<div class="card">

<div class="card-header">
    <h5>
        <span class="badge bg-light text-dark">
            Monthly Attendance (Editable)
        </span>
    </h5>
</div>

<div class="card-body">
<br>
 <a href="{% url 'Staff_Monthly_Summary' %}" class="btn btn-info">Monthly Summary</a>&nbsp;&nbsp;&nbsp;
 <a href="{% url 'reapply_holidays_attendance' %}" class="btn btn-info">Reply Holiday</a>
 <br>
<form method="GET" class="row mb-4">

    <div class="col-md-4">
        <label>Employee</label>
        <select name="employee" class="form-select" required>
            <option value="">Select Employee</option>
            {% for emp in employees %}
                <option value="{{ emp.id }}"
                {% if selected_employee and emp.id == selected_employee.id %}selected{% endif %}>
                    {{ emp.first_name }} {{ emp.last_name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-3">
        <label>Month</label>
        <input type="number" name="month" value="{{ month }}" min="1" max="12" class="form-control" required>
    </div>

    <div class="col-md-3">
        <label>Year</label>
        <input type="number" name="year" value="{{ year }}" class="form-control" required>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Search</button>
    </div>

</form>

{% if attendance_list %}

<form method="POST">
    {% csrf_token %}

    <div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Status</th>
                <th>Late</th>
                <th>First In</th>
                <th>Last Out</th>
                <th>Work Duration</th>
                <th>Punch Count</th>
            </tr>
        </thead>

        <tbody>
        {% for item in attendance_list %}
        <tr>

            <td>{{ item.full_date }}</td>
            <td>{{ item.full_date|date:"l" }}</td>
            <!-- STATUS DROPDOWN -->

                {% if item.status == 'Weekly-OFF' %}
                 <td>
                     <span class="badge bg-primary">Weekly Off</span>
                 </td>
                {% elif item.status == 'Special-OFF' %}
                 <td ><span class="badge bg-info">Special OFF</span></td>
                {% else %}
                <td>
                <select name="status_{{ item.day }}" class="form-select form-select-sm">
                    {% for key, value in status_choices %}
                        <option value="{{ key }}"
                        {% if item.status == key %}selected{% endif %}>
                            {{ value }}
                        </option>
                    {% endfor %}
                </select>
              </td>
             {% endif %}

            <!-- LATE -->
            <td>
                {% if item.late %}
                    <span class="status late">
                        YES{% if item.late_minutes %} ({{ item.late_minutes }} mins){% endif %}
                    </span>
                {% else %}
                    -
                {% endif %}
            </td>

            <td>
              {% if item.status == 'MIS_PUNCH' %}
                     <input type="time"
                         name="first_in_{{ item.day }}"
                         value="{% if item.first_in %}{{ item.first_in|time:'H:i' }}{% endif %}"
                         class="form-control form-control-sm">
              {% else %}
                    <input type="time"
                         value="{% if item.first_in %}{{ item.first_in|time:'H:i' }}{% endif %}"
                         class="form-control form-control-sm"
                         readonly>
              {% endif %}
             </td>
            <td>
    {% if item.status == 'MIS_PUNCH' %}
        <input type="time"
               name="last_out_{{ item.day }}"
               value="{% if item.last_out %}{{ item.last_out|time:'H:i' }}{% endif %}"
               class="form-control form-control-sm">
    {% else %}
        <input type="time"
               value="{% if item.last_out %}{{ item.last_out|time:'H:i' }}{% endif %}"
               class="form-control form-control-sm"
               readonly>
    {% endif %}
</td>

            <td>{{ item.work_duration|default:"-" }}</td>
            <td>{{ item.punch_count }}</td>

        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>

    <div class="text-end mt-3">
        <button type="submit" class="btn btn-success">
            Save Changes
        </button>
    </div>

</form>

{% endif %}

</div>
</div>
</div>

{% endblock %}
